---
import Layout from '../layouts/Layout.astro';
import { getCollection, getEntry } from 'astro:content';

const slug = Astro.url.searchParams.get('slug');
let listing = null;

if (slug) {
  listing = await getEntry('directory', slug);
}

// Redirect if no slug or listing found
if (!listing) {
  return Astro.redirect('/');
}

const businessName = listing.data.name;
---

<Layout title={`Claim ${businessName} - Gulf Islands Directory`}>
  <section class="py-20 bg-gray-50 min-h-screen flex items-center justify-center">
    <div class="max-w-2xl w-full mx-auto px-6">
      <div class="bg-white rounded-3xl p-8 md:p-12 shadow-xl shadow-ocean-900/5 border border-gray-100">
        <div class="text-center mb-10">
          <span class="inline-block px-3 py-1 bg-ocean-100 text-ocean-700 text-xs font-bold uppercase tracking-widest rounded-full mb-4">Verification</span>
          <h1 class="font-['Playfair_Display'] text-3xl md:text-4xl font-bold text-gray-900 leading-tight">
            Claim Your <span class="italic text-ocean-600">Listing</span>
          </h1>
          <p class="text-gray-500 mt-4 leading-relaxed">
            Verify ownership of <strong>{businessName}</strong> to manage your information and upgrade to premium features.
          </p>
        </div>

        <form id="claim-form" class="space-y-6">
          <input type="hidden" name="slug" value={slug} />
          <input type="hidden" name="business_name" value={businessName} />
          
          <!-- Honeypot -->
          <div class="hidden">
            <label for="honeypot">Leave this field empty</label>
            <input type="text" id="honeypot" name="honeypot" tabindex="-1" autocomplete="off" />
          </div>

          <div>
            <label for="business_name_display" class="block text-sm font-bold text-gray-700 uppercase tracking-wider mb-2">Business Name</label>
            <input 
              type="text" 
              id="business_name_display" 
              value={businessName} 
              readonly 
              class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-gray-500 outline-none"
            />
          </div>

          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <label for="claimant_name" class="block text-sm font-bold text-gray-700 uppercase tracking-wider mb-2">Full Name <span class="text-red-500">*</span></label>
              <input 
                type="text" 
                id="claimant_name" 
                name="claimant_name" 
                required 
                class="w-full bg-white border border-gray-200 rounded-xl px-4 py-3 text-gray-900 outline-none focus:ring-2 focus:ring-ocean-500 focus:border-transparent transition"
              />
            </div>
            <div>
              <label for="role" class="block text-sm font-bold text-gray-700 uppercase tracking-wider mb-2">Your Role <span class="text-red-500">*</span></label>
              <select 
                id="role" 
                name="role" 
                required 
                class="w-full bg-white border border-gray-200 rounded-xl px-4 py-3 text-gray-900 outline-none focus:ring-2 focus:ring-ocean-500 focus:border-transparent transition appearance-none cursor-pointer"
              >
                <option value="owner">Owner</option>
                <option value="manager">Manager</option>
                <option value="marketing">Marketing</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>

          <div>
            <label for="claimant_email" class="block text-sm font-bold text-gray-700 uppercase tracking-wider mb-2">Business Email <span class="text-red-500">*</span></label>
            <input 
              type="email" 
              id="claimant_email" 
              name="claimant_email" 
              required 
              class="w-full bg-white border border-gray-200 rounded-xl px-4 py-3 text-gray-900 outline-none focus:ring-2 focus:ring-ocean-500 focus:border-transparent transition"
            />
          </div>

          <div>
            <label for="phone" class="block text-sm font-bold text-gray-700 uppercase tracking-wider mb-2">Phone Number <span class="text-red-500">*</span></label>
            <input 
              type="tel" 
              id="phone" 
              name="phone" 
              required 
              class="w-full bg-white border border-gray-200 rounded-xl px-4 py-3 text-gray-900 outline-none focus:ring-2 focus:ring-ocean-500 focus:border-transparent transition"
            />
          </div>

          <div>
            <label for="professional_link" class="block text-sm font-bold text-gray-700 uppercase tracking-wider mb-2">Professional Link (Optional)</label>
            <input 
              type="url" 
              id="professional_link" 
              name="professional_link" 
              placeholder="https://linkedin.com/in/..."
              class="w-full bg-white border border-gray-200 rounded-xl px-4 py-3 text-gray-900 outline-none focus:ring-2 focus:ring-ocean-500 focus:border-transparent transition"
            />
            <p class="text-[10px] text-gray-400 mt-2 italic px-1">E.g. LinkedIn profile or business website team page. Helps us verify faster.</p>
          </div>

          <div>
            <label for="message" class="block text-sm font-bold text-gray-700 uppercase tracking-wider mb-2">Message or Content Request</label>
            <textarea 
              id="message" 
              name="message" 
              rows="3"
              placeholder="I'd like to claim my listing and would also like you to write professional SEO content for my site."
              class="w-full bg-white border border-gray-200 rounded-xl px-4 py-3 text-gray-900 outline-none focus:ring-2 focus:ring-ocean-500 focus:border-transparent transition resize-none"
            ></textarea>
            <p class="text-[10px] text-gray-400 mt-2 italic px-1">Check here if you'd like us to help write your business description!</p>
          </div>

          <!-- Placeholder for Mosparo -->
          <div id="mosparo-container" class="mt-4"></div>

          <button 
            type="submit" 
            id="submit-btn"
            class="w-full bg-ocean-600 hover:bg-ocean-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-ocean-900/10 transition transform hover:-translate-y-0.5 active:translate-y-0"
          >
            Submit Claim Verification
          </button>
        </form>

        <div id="success-message" class="hidden text-center py-10">
          <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
          </div>
          <h2 class="text-2xl font-bold text-gray-900 mb-2">Claim Received!</h2>
          <p class="text-gray-500 leading-relaxed">
            Thank you! We'll review your verification request and get back to you within 48 hours via email.
          </p>
          <a href="/" class="inline-block mt-8 text-ocean-600 font-bold hover:underline">‚Üê Back to Directory</a>
        </div>

        <div id="error-message" class="hidden text-center py-6">
          <p class="text-red-500 font-medium bg-red-50 p-4 rounded-xl border border-red-100">
            Sorry, there was an error submitting your claim. Please try again or contact support.
          </p>
          <button id="retry-btn" class="mt-4 text-ocean-600 font-bold hover:underline">Try again</button>
        </div>
      </div>
    </div>
  </section>
</Layout>

<script>
  const form = document.getElementById('claim-form') as HTMLFormElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const successMessage = document.getElementById('success-message');
  const errorMessage = document.getElementById('error-message');
  const retryBtn = document.getElementById('retry-btn');

  // Endpoint from Bastion
  const WORKER_ENDPOINT = 'https://gulfislands-claim-processor.jpjanze.workers.dev/api/claim';

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Simple honeypot check
    const honeypot = (document.getElementById('honeypot') as HTMLInputElement)?.value;
    if (honeypot) {
      console.warn('Bot detected');
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';
    errorMessage?.classList.add('hidden');

    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    try {
      const response = await fetch(WORKER_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (response.ok) {
        form.classList.add('hidden');
        successMessage?.classList.remove('hidden');
      } else {
        throw new Error('Submit failed');
      }
    } catch (err) {
      errorMessage?.classList.remove('hidden');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit Claim Verification';
    }
  });

  retryBtn?.addEventListener('click', () => {
    errorMessage?.classList.add('hidden');
  });
</script>
